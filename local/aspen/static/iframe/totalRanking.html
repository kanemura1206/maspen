<html>
  <head>
    <link rel="stylesheet" href="http://konoha.ubicg.ynu.ac.jp/maspen/local/aspen/static/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <script src="http://konoha.ubicg.ynu.ac.jp/maspen/local/aspen/static/js/vendor/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://konoha.ubicg.ynu.ac.jp/maspen/local/aspen/static/css/bootstrap.min.css">
    <script type='text/javascript'>
      google.load('visualization', '1', {packages:['table']});
      google.setOnLoadCallback(drawTable);
      setInterval(drawTable, 10000);
      var cmid = getUrlVars()["cmid"];
      var userid = getUrlVars()["userid"];

      function getUrlVars(){
         var vars = [], hash;
         var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
         for(var i = 0; i < hashes.length; i++){
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
         }
         return vars;
      }

      function parse_time(ts) {
	     if(ts == null){
	        return "Not submitted";
	     }
         var d = new Date( ts * 1000 );
         var year  = d.getFullYear();
         var month = d.getMonth() + 1;
         month = ( month   < 10 ) ? '0' + month   : month;
         var day  = ( d.getDate()    < 10 ) ? '0' + d.getDate()    : d.getDate();
         var hour = ( d.getHours()   < 10 ) ? '0' + d.getHours()   : d.getHours();
         var min  = ( d.getMinutes() < 10 ) ? '0' + d.getMinutes() : d.getMinutes();
         var sec  = ( d.getSeconds() < 10 ) ? '0' + d.getSeconds() : d.getSeconds();
         return year + '/' + month + '/' + day + ' ' + hour + ':' + min + ':' + sec;
      }

      var table;
      var data;

      function drawTable() {
        data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
	data.addColumn('number', 'Submission');
        data.addColumn('number', 'Number of correct answers');
        data.addColumn('string', 'Percentage of correct answers');

        var jsonData = $.ajax({
           url: "http://konoha.ubicg.ynu.ac.jp/maspen/webservice/rest/server.php",
           dataType: "json",
           async: false,
           data: {
                wstoken: "2d1a05efd36f0751a6a9fa7c6e3179e7",
                wsfunction: "local_exfunctions_get_total_runking",
                moodlewsrestformat: "json",
                cmid: cmid,
           }
        }).responseText;
        var obj = jQuery.parseJSON(jsonData);
	    var array = [];
	    var i = 0, row = -1;
	    while(i < obj.length){
	    	   var num = array.push([obj[i].username, obj[i].submission, obj[i].num_of_correct, obj[i].per_of_correct + "%"]) - 1;
	    	   if(obj[i].userid == userid){
	    		     row = num;
	    	   }
	    	   i++;
	    }

        data.addRows(array);
		if(row != -1){
			data.setProperty(row, 0, 'style', 'background-color: yellow;');
			data.setProperty(row, 1, 'style', 'background-color: yellow;');
			data.setProperty(row, 2, 'style', 'background-color: yellow;');
			data.setProperty(row, 3, 'style', 'background-color: yellow;');
		}
	data.sort([{column: 2, desc: true}, {column: 3, desc: true}, {column: 1, desc: true}]);
        table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {showRowNumber: true, allowHtml: true});
	//google.visualization.events.addListener(table, 'select', selectHandler);
      }

      function selectHandler() {
          var selection = table.getSelection();
	      for (var i = 0; i < selection.length; i++) {
              var item = selection[i];
              var str = data.getFormattedValue(item.row, 0);
	      $(window.parent.document).find('#modal-submit').modal("show");
          }
      }
    </script>
  </head>

  <body>
    <h3>Total Ranking</h3>
    <div id='table_div'></div>
  </body>
</html>
