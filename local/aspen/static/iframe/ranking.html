<html>
  <head>
    <link rel="stylesheet" href="http://konoha.ubicg.ynu.ac.jp/maspen/local/aspen/static/css/bootstrap.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <script type='text/javascript'>
      google.load('visualization', '1', {packages:['table']});
      google.setOnLoadCallback(drawTable);
      setInterval(drawTable, 10000);
      var id = getUrlVars()["id"];
      var userid = getUrlVars()["userid"];

      function getUrlVars(){
         var vars = [], hash;
         var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
         for(var i = 0; i < hashes.length; i++){
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
         }
         return vars;
      }

      function parse_time(ts) {
	 if(ts == null){
	    return "Not submitted";
	 }
         var d = new Date( ts * 1000 );
         var year  = d.getFullYear();
         var month = d.getMonth() + 1;
         month = ( month   < 10 ) ? '0' + month   : month;
         var day  = ( d.getDate()    < 10 ) ? '0' + d.getDate()    : d.getDate();
         var hour = ( d.getHours()   < 10 ) ? '0' + d.getHours()   : d.getHours();
         var min  = ( d.getMinutes() < 10 ) ? '0' + d.getMinutes() : d.getMinutes();
         var sec  = ( d.getSeconds() < 10 ) ? '0' + d.getSeconds() : d.getSeconds();
         return year + '年' + month + '月' + day + '日 ' + hour + '時' + min + '分' + sec + '秒';
      }

      function drawTable() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('number', 'Code');
        data.addColumn('number', 'Error');
	data.addColumn('string', 'Submission');

        var jsonData = $.ajax({
           url: "http://konoha.ubicg.ynu.ac.jp/maspen/webservice/rest/server.php",
           dataType: "json",
           async: false,
           data: {
                wstoken: "2d1a05efd36f0751a6a9fa7c6e3179e7",
                wsfunction: "local_exfunctions_get_runking",
                moodlewsrestformat: "json",
                id: id,
           }
         }).responseText;
         var obj = jQuery.parseJSON(jsonData);
	 var array = [];
	 var i = 0;
	 while(i < obj.length){
	    var num = array.push([obj[i].username, obj[i].code, obj[i].error, parse_time(obj[i].timemodified)]) - 1;
	    if(obj[i].userid == userid){
		var row = num;
	    }
	    i++;
	 }

        data.addRows(array);
	data.setProperty(row, 0, 'style', 'background-color: yellow;');
	data.setProperty(row, 1, 'style', 'background-color: yellow;');
	data.setProperty(row, 2, 'style', 'background-color: yellow;');
	data.setProperty(row, 3, 'style', 'background-color: yellow;');
	data.sort([{column: 3}, {column: 1, desc: true}]);
        var table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {showRowNumber: true, allowHtml: true});
      }
    </script>
  </head>

  <body>
    <h3>Ranking</h3>
    <div id='table_div'></div>
  </body>
</html>
